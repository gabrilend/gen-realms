<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symbeline Realms</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <header id="game-header">
            <h1>Symbeline Realms</h1>
            <span id="connection-status" class="disconnected">Disconnected</span>
        </header>

        <div id="canvas-container">
            <canvas id="game-canvas"></canvas>

            <div id="loading-overlay">
                <div id="loading-text">Loading...</div>
                <div class="loading-spinner"></div>
                <div id="loading-error"></div>
            </div>

            <div id="connect-dialog" class="hidden">
                <h2>Connect to Server</h2>
                <input type="text" id="server-url" placeholder="ws://localhost:8080" value="ws://localhost:8080">
                <button id="connect-btn">Connect</button>
            </div>
        </div>
    </div>

    <!-- Tooltip for card hover info -->
    <div id="tooltip">
        <div class="tooltip-name"></div>
        <div class="tooltip-cost"></div>
        <div class="tooltip-effect"></div>
    </div>

    <!-- Canvas layout system -->
    <script src="canvas.js"></script>

    <!-- Card rendering -->
    <script src="card-renderer.js"></script>

    <!-- Wasm module (generated by Emscripten) - only if built -->
    <script src="symbeline.js" onerror="window.wasmLoadFailed=true"></script>

    <!-- Initialize game -->
    <script>
        (async function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingError = document.getElementById('loading-error');
            const connectDialog = document.getElementById('connect-dialog');
            const serverUrlInput = document.getElementById('server-url');
            const connectBtn = document.getElementById('connect-btn');
            const connectionStatus = document.getElementById('connection-status');

            /* Initialize canvas layout system first */
            if (!window.canvasLayout.init('game-canvas')) {
                loadingText.textContent = 'Canvas Initialization Failed';
                loadingError.textContent = 'Browser may not support HTML5 Canvas';
                loadingError.style.display = 'block';
                return;
            }

            /* Check if Wasm is available */
            const wasmAvailable = typeof SymbelineRealms !== 'undefined' && !window.wasmLoadFailed;

            if (!wasmAvailable) {
                /* Run in demo mode without Wasm */
                loadingText.textContent = 'Demo Mode';
                loadingError.textContent = 'Wasm not built. Run: ./scripts/build-wasm.sh';
                loadingError.style.display = 'block';

                /* Start demo render loop to show layout */
                setTimeout(function() {
                    loadingOverlay.classList.add('hidden');
                    startDemoMode();
                }, 2000);
                return;
            }

            /* Initialize the Wasm module */
            loadingText.textContent = 'Loading Wasm...';

            const success = await window.symbeline.init('game-canvas');

            if (!success) {
                loadingText.textContent = 'Initialization Failed';
                loadingError.textContent = 'Check console for details';
                loadingError.style.display = 'block';
                return;
            }

            /* Hide loading, show connect dialog */
            loadingOverlay.classList.add('hidden');
            connectDialog.classList.remove('hidden');

            /* Handle connection */
            connectBtn.addEventListener('click', function() {
                const url = serverUrlInput.value.trim();
                if (!url) return;

                connectionStatus.textContent = 'Connecting...';
                connectionStatus.className = 'connecting';
                connectDialog.classList.add('hidden');

                window.symbeline.connect(url);
            });

            /* Update connection status */
            setInterval(function() {
                if (window.symbeline.isConnected()) {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'connected';
                } else if (connectionStatus.className === 'connecting') {
                    /* Stay in connecting state */
                } else {
                    connectionStatus.textContent = 'Disconnected';
                    connectionStatus.className = 'disconnected';
                }
            }, 1000);

            /* Allow Enter to connect */
            serverUrlInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    connectBtn.click();
                }
            });
        })();

        /* Demo mode - renders layout without Wasm for testing */
        function startDemoMode() {
            const ctx = window.canvasLayout.getContext();
            const layout = window.canvasLayout.getLayout();

            /* Sample cards for demo */
            const sampleCards = [
                { name: 'Trade Envoy', cost: 1, faction: 'merchant', kind: 'ship',
                  effects: [{ type: 'trade', value: 2 }] },
                { name: 'Dire Wolf', cost: 3, faction: 'wilds', kind: 'ship',
                  effects: [{ type: 'combat', value: 4 }] },
                { name: 'Royal Guard', cost: 4, faction: 'kingdom', kind: 'base',
                  defense: 5, isOutpost: true,
                  effects: [{ type: 'authority', value: 2 }] },
                { name: 'Gear Smith', cost: 2, faction: 'artificer', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }, { type: 'draw', value: 1 }],
                  tradeBonus: 1 },
                { name: 'Explorer', cost: 2, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 2 }] }
            ];

            const handCards = [
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] },
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] },
                { name: 'Viper', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'combat', value: 1 }] },
                { name: 'Trade Envoy', cost: 1, faction: 'merchant', kind: 'ship',
                  effects: [{ type: 'trade', value: 2 }], attackBonus: 1 },
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] }
            ];

            let hoveredCard = -1;
            let selectedCard = 2; /* Demo: card 3 selected */

            function renderDemo(ctx, dt, time) {
                /* Clear canvas */
                window.canvasLayout.clear();

                /* Draw all layout regions */
                window.canvasLayout.drawRegionBorder('status', 'STATUS', '#444');
                window.canvasLayout.drawRegionBorder('tradeRow', 'TRADE ROW', '#d4a017');
                window.canvasLayout.drawRegionBorder('hand', 'YOUR HAND', '#44cccc');
                window.canvasLayout.drawRegionBorder('playerBases', 'BASES', '#cc66cc');
                window.canvasLayout.drawRegionBorder('opponentBases', 'OPPONENT', '#cc3333');
                window.canvasLayout.drawRegionBorder('narrative', 'NARRATIVE', '#8866cc');
                window.canvasLayout.drawRegionBorder('playArea', 'PLAY AREA', '#333');

                /* Draw FPS counter and status */
                const fps = window.canvasLayout.getFps();
                ctx.fillStyle = '#666';
                ctx.font = '12px monospace';
                ctx.fillText('FPS: ' + fps + ' | Demo Mode', 10, layout.status.y + 25);

                /* Player stats demo */
                ctx.fillStyle = '#44cccc';
                ctx.fillText('Authority: 50', 200, layout.status.y + 25);
                ctx.fillStyle = '#888';
                ctx.fillText('D10: 5  D4: 0', 320, layout.status.y + 25);
                ctx.fillStyle = '#d4a017';
                ctx.fillText('Trade: 3', 440, layout.status.y + 25);
                ctx.fillStyle = '#cc66cc';
                ctx.fillText('Combat: 0', 520, layout.status.y + 25);

                const cardSize = window.cardRenderer.getCardSize();
                const cardSpacing = 10;

                /* Draw hand cards using card renderer */
                for (let i = 0; i < handCards.length; i++) {
                    const x = layout.hand.x + 10 + i * (cardSize.width + cardSpacing);
                    const y = layout.hand.y + 10;
                    window.cardRenderer.renderCard(ctx, handCards[i], x, y, {
                        selected: i === selectedCard,
                        hovered: i === hoveredCard
                    });
                }

                /* Draw trade row cards using card renderer */
                for (let i = 0; i < sampleCards.length; i++) {
                    const x = layout.tradeRow.x + 10 + i * (cardSize.width + cardSpacing);
                    const y = layout.tradeRow.y + 10;
                    window.cardRenderer.renderCard(ctx, sampleCards[i], x, y);
                }

                /* Draw a base in bases area */
                window.cardRenderer.renderCard(ctx, sampleCards[2],
                    layout.playerBases.x + 10, layout.playerBases.y + 10);

                /* Draw face-down card in opponent area */
                window.cardRenderer.renderCard(ctx,
                    { name: '', faction: 'neutral' },
                    layout.opponentBases.x + 10, layout.opponentBases.y + 10,
                    { faceDown: true });

                /* Narrative text */
                ctx.fillStyle = '#888';
                ctx.font = '11px monospace';
                const narrativeX = layout.narrative.x + 10;
                let narrativeY = layout.narrative.y + 20;
                const narrativeLines = [
                    'The merchant fleet arrives',
                    'at the frontier station,',
                    'their holds filled with',
                    'exotic goods from distant',
                    'worlds...',
                    '',
                    'Trade Envoy played.',
                    '+2 Trade',
                    '',
                    'What will you do next?'
                ];
                for (const line of narrativeLines) {
                    ctx.fillText(line, narrativeX, narrativeY);
                    narrativeY += 14;
                }
            }

            window.canvasLayout.startRenderLoop(renderDemo);
        }
    </script>
</body>
</html>
