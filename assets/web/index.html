<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symbeline Realms</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <header id="game-header">
            <h1>Symbeline Realms</h1>
            <div id="header-controls">
                <button id="prefs-btn" title="Preferences">&#9881;</button>
                <span id="connection-status" class="disconnected">Disconnected</span>
            </div>
        </header>

        <div id="canvas-container">
            <canvas id="game-canvas"></canvas>

            <div id="loading-overlay">
                <div id="loading-text">Loading...</div>
                <div class="loading-spinner"></div>
                <div id="loading-error"></div>
            </div>

            <div id="connect-dialog" class="hidden">
                <h2>Connect to Server</h2>
                <input type="text" id="server-url" placeholder="ws://localhost:8080" value="ws://localhost:8080">
                <button id="connect-btn">Connect</button>
            </div>
        </div>
    </div>

    <!-- Tooltip for card hover info -->
    <div id="tooltip">
        <div class="tooltip-name"></div>
        <div class="tooltip-cost"></div>
        <div class="tooltip-effect"></div>
    </div>

    <!-- Canvas layout system -->
    <script src="canvas.js"></script>

    <!-- Card rendering -->
    <script src="card-renderer.js"></script>

    <!-- Zone rendering -->
    <script src="zone-renderer.js"></script>

    <!-- Panel rendering (status bar, narrative) -->
    <script src="panel-renderer.js"></script>

    <!-- Preferences storage -->
    <script src="preferences.js"></script>

    <!-- Animation system -->
    <script src="animation.js"></script>

    <!-- Narrative display -->
    <script src="narrative.js"></script>

    <!-- Card animations -->
    <script src="card-animations.js"></script>

    <!-- Visual effects -->
    <script src="effects.js"></script>

    <!-- Preferences UI -->
    <script src="preferences-ui.js"></script>

    <!-- Draw order selection UI -->
    <script src="draw-order.js"></script>

    <!-- Input handling -->
    <script src="input-handler.js"></script>

    <!-- Wasm module (generated by Emscripten) - only if built -->
    <script src="symbeline.js" onerror="window.wasmLoadFailed=true"></script>

    <!-- Initialize game -->
    <script>
        (async function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingError = document.getElementById('loading-error');
            const connectDialog = document.getElementById('connect-dialog');
            const serverUrlInput = document.getElementById('server-url');
            const connectBtn = document.getElementById('connect-btn');
            const connectionStatus = document.getElementById('connection-status');

            /* Initialize canvas layout system first */
            if (!window.canvasLayout.init('game-canvas')) {
                loadingText.textContent = 'Canvas Initialization Failed';
                loadingError.textContent = 'Browser may not support HTML5 Canvas';
                loadingError.style.display = 'block';
                return;
            }

            /* Check if Wasm is available */
            const wasmAvailable = typeof SymbelineRealms !== 'undefined' && !window.wasmLoadFailed;

            if (!wasmAvailable) {
                /* Run in demo mode without Wasm */
                loadingText.textContent = 'Demo Mode';
                loadingError.textContent = 'Wasm not built. Run: ./scripts/build-wasm.sh';
                loadingError.style.display = 'block';

                /* Start demo render loop to show layout */
                setTimeout(function() {
                    loadingOverlay.classList.add('hidden');
                    startDemoMode();
                }, 2000);
                return;
            }

            /* Initialize the Wasm module */
            loadingText.textContent = 'Loading Wasm...';

            const success = await window.symbeline.init('game-canvas');

            if (!success) {
                loadingText.textContent = 'Initialization Failed';
                loadingError.textContent = 'Check console for details';
                loadingError.style.display = 'block';
                return;
            }

            /* Hide loading, show connect dialog */
            loadingOverlay.classList.add('hidden');
            connectDialog.classList.remove('hidden');

            /* Handle connection */
            connectBtn.addEventListener('click', function() {
                const url = serverUrlInput.value.trim();
                if (!url) return;

                connectionStatus.textContent = 'Connecting...';
                connectionStatus.className = 'connecting';
                connectDialog.classList.add('hidden');

                window.symbeline.connect(url);
            });

            /* Update connection status */
            setInterval(function() {
                if (window.symbeline.isConnected()) {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'connected';
                } else if (connectionStatus.className === 'connecting') {
                    /* Stay in connecting state */
                } else {
                    connectionStatus.textContent = 'Disconnected';
                    connectionStatus.className = 'disconnected';
                }
            }, 1000);

            /* Allow Enter to connect */
            serverUrlInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    connectBtn.click();
                }
            });
        })();

        /* Demo mode - renders layout without Wasm for testing */
        function startDemoMode() {
            const ctx = window.canvasLayout.getContext();
            const layout = window.canvasLayout.getLayout();
            const canvas = document.getElementById('game-canvas');

            /* Sample trade row cards */
            const tradeRowCards = [
                { name: 'Trade Envoy', cost: 1, faction: 'merchant', kind: 'ship',
                  effects: [{ type: 'trade', value: 2 }] },
                { name: 'Dire Wolf', cost: 3, faction: 'wilds', kind: 'ship',
                  effects: [{ type: 'combat', value: 4 }] },
                { name: 'Royal Guard', cost: 4, faction: 'kingdom', kind: 'base',
                  defense: 5, isOutpost: true,
                  effects: [{ type: 'authority', value: 2 }] },
                { name: 'Gear Smith', cost: 2, faction: 'artificer', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }, { type: 'draw', value: 1 }],
                  tradeBonus: 1 },
                null  /* Empty slot demo */
            ];

            const handCards = [
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] },
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] },
                { name: 'Viper', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'combat', value: 1 }] },
                { name: 'Trade Envoy', cost: 1, faction: 'merchant', kind: 'ship',
                  effects: [{ type: 'trade', value: 2 }], attackBonus: 1 },
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] }
            ];

            const playerBases = [
                { name: 'Royal Guard', cost: 4, faction: 'kingdom', kind: 'base',
                  defense: 5, isOutpost: true,
                  effects: [{ type: 'authority', value: 2 }] }
            ];

            const opponentBases = [
                { name: 'Trading Post', cost: 3, faction: 'merchant', kind: 'base',
                  defense: 4, isOutpost: false,
                  effects: [{ type: 'trade', value: 1 }] }
            ];

            const playedCards = [
                { name: 'Scout', cost: 0, faction: 'neutral', kind: 'ship',
                  effects: [{ type: 'trade', value: 1 }] },
                { name: 'Trade Envoy', cost: 1, faction: 'merchant', kind: 'ship',
                  effects: [{ type: 'trade', value: 2 }] }
            ];

            /* Demo game state for panel renderer */
            const gameState = {
                turn: 5,
                phase: 'main',
                player: {
                    authority: 50,
                    trade: 3,
                    combat: 0,
                    d10: 5,
                    d4: 0
                },
                opponent: {
                    authority: 48,
                    handCount: 4,
                    baseCount: 1
                },
                deckCount: 8,
                discardCount: 2
            };

            /* Load preferences and initialize systems */
            const prefs = window.preferences.load();
            window.animation.loadFromPreferences();
            window.narrative.loadFromPreferences();
            window.cardAnimations.init();

            /* Wire up preferences button */
            document.getElementById('prefs-btn').addEventListener('click', function() {
                window.preferencesUI.toggle();
            });

            /* Wire up draw order UI click handling */
            canvas.addEventListener('click', function(e) {
                if (window.drawOrderUI.isActive()) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    /* Check buttons first, then cards */
                    if (!window.drawOrderUI.handleButtonClick(x, y)) {
                        window.drawOrderUI.handleClick(x, y);
                    }
                }
            });

            canvas.addEventListener('mousemove', function(e) {
                if (window.drawOrderUI.isActive()) {
                    const rect = canvas.getBoundingClientRect();
                    window.drawOrderUI.handleMouseMove(
                        e.clientX - rect.left,
                        e.clientY - rect.top
                    );
                }
            });

            /* Add 'D' key to trigger draw order demo */
            document.addEventListener('keydown', function(e) {
                if (e.key === 'd' || e.key === 'D') {
                    if (!window.drawOrderUI.isActive() && !e.ctrlKey && !e.metaKey) {
                        /* Demo: show draw order UI with 5 cards */
                        window.drawOrderUI.show(5, function(order) {
                            window.narrative.addAction('Draw order set: ' +
                                order.map(function(i) { return i + 1; }).join(', '));
                        }, function() {
                            window.narrative.addSystem('Draw order cancelled');
                        });
                    }
                }
                if (e.key === 'Escape' && window.drawOrderUI.isActive()) {
                    window.drawOrderUI.cancel();
                }
            });

            /* Initialize narrative with demo entries */
            window.narrative.add(
                'The merchant fleet arrives at the frontier station, their holds filled with exotic goods from distant worlds.'
            );
            window.narrative.addAction('Trade Envoy played. +2 Trade');
            window.narrative.add(
                'The artificer guild watches with keen interest as gold changes hands.'
            );
            window.narrative.addSystem('What will you do next?');

            /* Initialize selection with one card */
            window.zoneRenderer.setSelectedCards([handCards[2]]);

            /* Initialize input handler */
            window.inputHandler.init(canvas);

            /* Demo action callbacks using narrative system */
            window.inputHandler.onAction('play_card', function(data) {
                const card = handCards[data.card_index];
                if (card) {
                    window.narrative.addAction(card.name + ' played.');
                    if (card.effects && card.effects.length > 0) {
                        const eff = card.effects[0];
                        if (eff.type === 'trade') {
                            gameState.player.trade += eff.value;
                            window.narrative.addAction('+' + eff.value + ' Trade');
                        } else if (eff.type === 'combat') {
                            gameState.player.combat += eff.value;
                            window.narrative.addAction('+' + eff.value + ' Combat');
                        }
                    }
                }
            });

            window.inputHandler.onAction('buy_card', function(data) {
                const card = tradeRowCards[data.slot_index];
                if (card && gameState.player.trade >= card.cost) {
                    gameState.player.trade -= card.cost;
                    window.narrative.addPurchase('Purchased ' + card.name + ' for ' + card.cost + ' gold.');
                } else {
                    window.inputHandler.showError('Not enough trade!');
                }
            });

            window.inputHandler.onAction('attack_player', function(data) {
                if (gameState.player.combat > 0) {
                    gameState.opponent.authority -= gameState.player.combat;
                    window.narrative.addAttack('Attacked opponent for ' + gameState.player.combat + ' damage!');
                    gameState.player.combat = 0;
                } else {
                    window.inputHandler.showError('No combat available!');
                }
            });

            window.inputHandler.onAction('end_turn', function(data) {
                gameState.turn++;
                gameState.player.trade = 0;
                gameState.player.combat = 0;
                window.narrative.addTurn('Turn ended. Turn ' + gameState.turn + ' begins.');
            });

            function renderDemo(ctx, dt, time) {
                /* Clear canvas and click bounds */
                window.canvasLayout.clear();
                window.zoneRenderer.clearClickBounds();

                /* Draw region borders for zones that aren't rendered by panel/zone renderers */
                window.canvasLayout.drawRegionBorder('playArea', '', '#222');

                /* Status bar using panel renderer */
                window.panelRenderer.renderStatusBar(ctx, gameState, layout.status);

                /* Draw FPS overlay */
                const fps = window.canvasLayout.getFps();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(layout.status.x + layout.status.w - 200, layout.status.y + 2, 195, 16);
                ctx.fillStyle = '#888';
                ctx.font = '10px monospace';
                ctx.textAlign = 'right';
                ctx.fillText('FPS: ' + fps + ' | Demo Mode', layout.status.x + layout.status.w - 10, layout.status.y + 13);

                /* Render zones using zone renderer */
                window.zoneRenderer.renderTradeRow(ctx, tradeRowCards, layout.tradeRow, gameState.player.trade);
                window.zoneRenderer.renderHand(ctx, handCards, layout.hand);
                window.zoneRenderer.renderBases(ctx, playerBases, layout.playerBases, false);
                window.zoneRenderer.renderBases(ctx, opponentBases, layout.opponentBases, true);
                window.zoneRenderer.renderPlayedCards(ctx, playedCards, layout.playArea);

                /* Deck and discard indicators */
                window.zoneRenderer.renderDeckIndicator(ctx, gameState.deckCount,
                    layout.hand.x + layout.hand.w - 70, layout.hand.y + 10);
                window.zoneRenderer.renderDiscardIndicator(ctx, gameState.discardCount,
                    layout.hand.x + layout.hand.w - 70, layout.hand.y + 90, playedCards[0]);

                /* Narrative panel using narrative system */
                window.narrative.render(ctx, layout.narrative);

                /* Error message overlay */
                window.inputHandler.renderError(ctx, layout.status);

                /* Action buttons */
                const buttonRegion = {
                    x: layout.hand.x,
                    y: layout.hand.y + layout.hand.h - 40,
                    w: layout.hand.w - 100,
                    h: 35
                };
                window.inputHandler.renderActionButtons(ctx, buttonRegion, gameState);

                /* Render card animations (on top of everything) */
                window.cardAnimations.render(ctx);

                /* Render visual effects (on top of card animations) */
                window.effects.render(ctx, canvas.width, canvas.height);

                /* Render draw order UI (on top of everything when active) */
                window.drawOrderUI.render(ctx, canvas.width, canvas.height);
            }

            window.canvasLayout.startRenderLoop(renderDemo);
        }
    </script>
</body>
</html>
